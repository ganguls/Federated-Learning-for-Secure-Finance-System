<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FL Enterprise Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            /* Dark theme colors (SOCRadar inspired) */
            --dark-primary-bg: #1a1d23;
            --dark-secondary-bg: #242832;
            --dark-card-bg: #2d3142;
            --dark-sidebar-bg: #1e2129;
            --dark-border-color: #3a3f4b;
            --dark-text-primary: #ffffff;
            --dark-text-secondary: #b8bcc8;
            --dark-text-muted: #8b92a8;
            
            /* Light theme colors */
            --light-primary-bg: #f8fafc;
            --light-secondary-bg: #ffffff;
            --light-card-bg: #ffffff;
            --light-sidebar-bg: #f1f5f9;
            --light-border-color: #e2e8f0;
            --light-text-primary: #1e293b;
            --light-text-secondary: #475569;
            --light-text-muted: #64748b;
            
            /* SOCRadar brand colors */
            --primary-blue: #3b82f6;
            --primary-blue-hover: #2563eb;
            --primary-blue-light: rgba(59, 130, 246, 0.1);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #06b6d4;
            --purple-accent: #8b5cf6;
            --orange-accent: #f97316;
            --green-accent: #22c55e;
            
            /* Current theme variables */
            --current-primary-bg: var(--dark-primary-bg);
            --current-secondary-bg: var(--dark-secondary-bg);
            --current-card-bg: var(--dark-card-bg);
            --current-sidebar-bg: var(--dark-sidebar-bg);
            --current-border-color: var(--dark-border-color);
            --current-text-primary: var(--dark-text-primary);
            --current-text-secondary: var(--dark-text-secondary);
            --current-text-muted: var(--dark-text-muted);
        }

        [data-theme="light"] {
            --current-primary-bg: var(--light-primary-bg);
            --current-secondary-bg: var(--light-secondary-bg);
            --current-card-bg: var(--light-card-bg);
            --current-sidebar-bg: var(--light-sidebar-bg);
            --current-border-color: var(--light-border-color);
            --current-text-primary: var(--light-text-primary);
            --current-text-secondary: var(--light-text-secondary);
            --current-text-muted: var(--light-text-muted);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--current-primary-bg);
            color: var(--current-text-primary);
            line-height: 1.6;
        }

        .dashboard-wrapper {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--current-secondary-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--current-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h1 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .header-nav {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            color: var(--current-text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            background: var(--current-primary-bg);
            border: 1px solid var(--current-border-color);
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border-radius: 8px;
            color: var(--current-text-primary);
            font-size: 0.9rem;
            width: 250px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            color: var(--current-text-muted);
            font-size: 0.9rem;
        }

        .theme-toggle {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--current-text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .theme-toggle:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--current-text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.stopped {
            background: var(--error-color);
        }

        .status-dot.starting {
            background: var(--warning-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--current-text-primary);
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--current-text-muted);
        }

        .btn-logout {
            background: var(--error-color);
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: var(--current-sidebar-bg);
            border-right: 1px solid var(--current-border-color);
            padding: 1.5rem;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h3 {
            color: var(--current-text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.25rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--current-text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        .sidebar-menu a.active {
            font-weight: 500;
        }

        .info-panel {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .info-panel h4 {
            color: var(--current-text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--current-border-color);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--current-text-secondary);
            font-size: 0.85rem;
        }

        .info-value {
            color: var(--current-text-primary);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--current-primary-bg);
        }

        .content-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--current-text-primary);
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--current-text-secondary);
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: fit-content;
            font-weight: 500;
            color: var(--current-text-secondary);
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .tab:hover:not(.active) {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        .tab-content {
            display: none;
            width: 100%;
            overflow-x: hidden;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .metric-card {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        .metric-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .metric-card h3 {
            color: var(--current-text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--current-text-primary);
        }

        .metric-change {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--error-color);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--current-border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-blue);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .chart-card {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--current-text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            background: var(--current-primary-bg);
            border: 1px solid var(--current-border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            color: var(--current-text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .client-chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            width: 100%;
        }
        
        .client-chart-item {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 12px;
            padding: 1.25rem;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .client-chart-item h4 {
            margin: 0 0 1rem 0;
            color: var(--current-text-primary);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chart-container {
            width: 100%;
            height: 280px;
            position: relative;
            margin: 0;
            overflow: hidden;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .main-chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            margin: 0;
            overflow: hidden;
        }

        .main-chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .actions-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: var(--current-card-bg);
            color: var(--current-text-primary);
            border: 1px solid var(--current-border-color);
        }

        .btn.secondary:hover {
            background: var(--current-border-color);
        }

        .btn.success { background: var(--success-color); }
        .btn.warning { background: var(--warning-color); }
        .btn.danger { background: var(--error-color); }
        .btn.info { background: var(--info-color); }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--error-color); }
        .notification.warning { background: var(--warning-color); }
        .notification.info { background: var(--info-color); }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            background: var(--current-card-bg);
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--current-text-muted);
            margin-top: 0.25rem;
        }

        .footer {
            background: var(--current-secondary-bg);
            border-top: 1px solid var(--current-border-color);
            padding: 1.5rem 2rem;
            margin-top: auto;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-left {
            color: var(--current-text-secondary);
            font-size: 0.9rem;
        }

        .footer-right {
            display: flex;
            gap: 2rem;
        }

        .footer-link {
            color: var(--current-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--primary-blue);
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 260px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 1rem;
            }
            
            .client-chart-grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 1rem;
            }

            .main-chart-container {
                height: 350px;
            }
            
            .chart-container {
                height: 250px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-nav {
                display: none;
            }

            .search-input {
                width: 200px;
            }

            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                border-right: none;
                border-top: 1px solid var(--current-border-color);
            }
            
            .main-content {
                order: 1;
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .client-chart-grid {
                grid-template-columns: 1fr;
            }

            .main-chart-container {
                height: 300px;
            }
            
            .chart-container {
                height: 220px;
            }

            .tabs {
                overflow-x: auto;
            }

            .footer-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .header-right {
                flex-direction: column;
                gap: 0.5rem;
            }

            .search-input {
                width: 150px;
            }
            
            .main-content {
                padding: 0.75rem;
            }
            
            .main-chart-container {
                height: 250px;
            }
            
            .chart-container {
                height: 200px;
            }

            .actions-bar {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="dashboard-wrapper">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h1>FL Enterprise</h1>
                </div>
                <nav class="header-nav">
                    <a href="#" class="nav-item active">Dashboard</a>
                    <a href="#" class="nav-item">Analytics</a>
                    <a href="#" class="nav-item">Reports</a>
                    <a href="#" class="nav-item">Settings</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search...">
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="status-indicator">
                    <span>System:</span>
                    <div class="status-dot" id="systemStatusDot"></div>
                    <span id="systemStatusText">Online</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar">{{ session.username[0].upper() if session.username else 'U' }}</div>
                    <div class="user-details">
                        <div class="user-name">{{ session.username or 'User' }}</div>
                        <div class="user-role">Administrator</div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Navigation</h3>
                    <ul class="sidebar-menu">
                        <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li><a href="#"><i class="fas fa-users"></i> Clients</a></li>
                        <li><a href="#"><i class="fas fa-brain"></i> Models</a></li>
                        <li><a href="#"><i class="fas fa-chart-line"></i> Training</a></li>
                        <li><a href="#"><i class="fas fa-database"></i> Datasets</a></li>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3>Monitoring</h3>
                    <ul class="sidebar-menu">
                        <li><a href="#"><i class="fas fa-heartbeat"></i> System Health</a></li>
                        <li><a href="#"><i class="fas fa-shield-alt"></i> Security</a></li>
                        <li><a href="#"><i class="fas fa-bell"></i> Alerts</a></li>
                        <li><a href="#"><i class="fas fa-history"></i> Logs</a></li>
                    </ul>
                </div>

                <div class="info-panel">
                    <h4><i class="fas fa-info-circle"></i> System Status</h4>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="systemStatus">Running</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Active Clients:</span>
                        <span class="info-value" id="activeClients">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Training Rounds:</span>
                        <span class="info-value" id="trainingRounds">0</span>
                    </div>
                </div>

                <div class="info-panel">
                    <h4><i class="fas fa-shield-alt"></i> Security</h4>
                    <div class="info-item">
                        <span class="info-label">CA Status:</span>
                        <span class="info-value" id="caStatus">Active</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Certificates:</span>
                        <span class="info-value" id="caCertificates">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Network:</span>
                        <span class="info-value" id="networkStatus">Secure</span>
                    </div>
                </div>

                <div class="info-panel">
                    <h4><i class="fas fa-server"></i> Resources</h4>
                    <div class="info-item">
                        <span class="info-label">CPU:</span>
                        <span class="info-value" id="quickCpu">0%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Memory:</span>
                        <span class="info-value" id="quickMemory">0%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Storage:</span>
                        <span class="info-value" id="quickStorage">45%</span>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="content-header">
                    <div>
                        <h1 class="content-title">Federated Learning Dashboard</h1>
                        <p class="content-subtitle">Monitor and manage your distributed machine learning infrastructure</p>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="overview">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </div>
                    <div class="tab" data-tab="monitoring">
                        <i class="fas fa-chart-line"></i> Monitoring
                    </div>
                    <div class="tab" data-tab="clients">
                        <i class="fas fa-users"></i> Client Training
                    </div>
                    <div class="tab" data-tab="models">
                        <i class="fas fa-brain"></i> Models
                    </div>
                    <div class="tab" data-tab="security">
                        <i class="fas fa-shield-alt"></i> Security
                    </div>
                    <div class="tab" data-tab="settings">
                        <i class="fas fa-cogs"></i> Settings
                    </div>
                    <div class="tab" data-tab="demo">
                        <i class="fas fa-flask"></i> Demo
                    </div>
                </div>

                <div class="tab-content active" id="overview">
                    <div class="actions-bar">
                        <button class="btn">
                            <i class="fas fa-play"></i> Start Training
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-download"></i> Export Model
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-upload"></i> Import Dataset
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>

                    <div class="stats-overview">
                        <div class="stat-item">
                            <div class="stat-number" id="totalClients">0</div>
                            <div class="stat-label">Total Clients</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeTraining">0</div>
                            <div class="stat-label">Active Training</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="completedRounds">0</div>
                            <div class="stat-label">Completed Rounds</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="modelAccuracy">0%</div>
                            <div class="stat-label">Model Accuracy</div>
                        </div>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <h3><i class="fas fa-microchip metric-icon"></i> CPU Usage</h3>
                            <div class="metric-value" id="cpuUsage">0%</div>
                            <div class="metric-change positive" id="cpuChange">+2.3% from last hour</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="cpuProgress" style="width: 0%; background: var(--primary-blue);"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3><i class="fas fa-memory metric-icon"></i> Memory Usage</h3>
                            <div class="metric-value" id="memoryUsage">0%</div>
                            <div class="metric-change negative" id="memoryChange">-1.2% from last hour</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="memoryProgress" style="width: 0%; background: var(--success-color);"></div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3><i class="fas fa-docker metric-icon"></i> Active Containers</h3>
                            <div class="metric-value" id="dockerContainers">0</div>
                            <div class="metric-change positive" id="containerChange">All containers healthy</div>
                            <div class="status-badge active" style="margin-top: 0.5rem;">
                                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                Online
                            </div>
                        </div>

                        <div class="metric-card">
                            <h3><i class="fas fa-network-wired metric-icon"></i> Network Traffic</h3>
                            <div class="metric-value" id="networkTraffic">0 MB/s</div>
                            <div class="metric-change positive" id="networkChange">↑ 15.4 MB/s peak</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 65%; background: var(--warning-color);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="monitoring">
                    <div class="actions-bar">
                        <button class="btn secondary">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-calendar"></i> Set Time Range
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-filter"></i> Filter Metrics
                        </button>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-line"></i> System Performance
                            </h3>
                            <div class="chart-actions">
                                <button class="chart-btn">1H</button>
                                <button class="chart-btn">6H</button>
                                <button class="chart-btn">24H</button>
                                <button class="chart-btn">7D</button>
                            </div>
                        </div>
                        <div class="main-chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-brain"></i> Training Progress
                            </h3>
                            <div class="chart-actions">
                                <button class="chart-btn">Accuracy</button>
                                <button class="chart-btn">Loss</button>
                                <button class="chart-btn">Both</button>
                            </div>
                        </div>
                        <div class="main-chart-container">
                            <canvas id="trainingChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="clients">
                    <div class="actions-bar">
                        <button class="btn">
                            <i class="fas fa-plus"></i> Add Client
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-sync-alt"></i> Sync All
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-cog"></i> Configure
                        </button>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-users"></i> Individual Client Training Progress
                            </h3>
                            <div class="chart-actions">
                                <button class="chart-btn">Real-time</button>
                                <button class="chart-btn">Export</button>
                            </div>
                        </div>
                        <div id="clientChartsContainer">
                            <div class="client-chart-grid" id="clientChartsGrid">
                                <!-- Client charts will be dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="models">
                    <div class="actions-bar">
                        <button class="btn">
                            <i class="fas fa-plus"></i> Create Model
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-upload"></i> Import Model
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-copy"></i> Clone Model
                        </button>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-brain"></i> Model Management
                            </h3>
                        </div>
                        <div style="padding: 2rem; text-align: center; color: var(--current-text-secondary);">
                            <i class="fas fa-brain" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <h4>Model Management Interface</h4>
                            <p>Create, train, and deploy federated learning models</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="security">
                    <div class="actions-bar">
                        <button class="btn">
                            <i class="fas fa-key"></i> Generate Certificate
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-shield-alt"></i> Security Scan
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-history"></i> Audit Log
                        </button>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-certificate"></i> Certificate Management
                            </h3>
                        </div>
                        <div id="certStatus" style="padding: 2rem;">
                            <div style="text-align: center; color: var(--current-text-secondary);">
                                <i class="fas fa-certificate" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <h4>Certificate Authority Status</h4>
                                <p>Manage SSL/TLS certificates for secure federated learning</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="settings">
                    <div class="actions-bar">
                        <button class="btn">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                        <button class="btn secondary">
                            <i class="fas fa-download"></i> Export Settings
                        </button>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-cogs"></i> System Configuration
                            </h3>
                        </div>
                        <div style="padding: 2rem; text-align: center; color: var(--current-text-secondary);">
                            <i class="fas fa-cogs" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <h4>Configuration Panel</h4>
                            <p>Adjust system settings and parameters</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="demo">
                    <div class="actions-bar">
                        <button class="btn danger" onclick="resetAllClients()">
                            <i class="fas fa-undo"></i> Reset All Clients
                        </button>
                        <button class="btn secondary" onclick="refreshDemoData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn secondary" onclick="simulateAttack()">
                            <i class="fas fa-bug"></i> Simulate Attack
                        </button>
                        <button class="btn primary" onclick="runEnhancedDetection()">
                            <i class="fas fa-shield-alt"></i> Run Detection
                        </button>
                        <button class="btn secondary" onclick="runAttackDetection()">
                            <i class="fas fa-flask"></i> Run Demo
                        </button>
                        <button class="btn warning" onclick="toggleDetection()">
                            <i class="fas fa-toggle-on"></i> Toggle Detection
                        </button>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-flask"></i> Malicious Client Simulation
                            </h3>
                            <div class="chart-controls">
                                <span class="status-indicator">
                                    <span class="status-text" id="demo-status">Ready</span>
                                </span>
                            </div>
                        </div>
                        <div style="padding: 1rem;">
                            <p style="margin-bottom: 1.5rem; color: var(--current-text-secondary);">
                                Interactive demonstration of federated learning with malicious clients. 
                                Toggle clients between normal and malicious behavior to observe the system's defense mechanisms.
                            </p>
                            
                            <div class="demo-controls" style="display: flex; gap: 2rem; margin-bottom: 2rem; padding: 1rem; background: var(--current-card-bg); border-radius: 8px;">
                                <div class="info-item">
                                    <span class="label" style="color: var(--current-text-secondary);">Total Clients:</span>
                                    <span class="value" id="total-clients" style="font-weight: bold; color: var(--primary-blue);">10</span>
                                </div>
                                <div class="info-item">
                                    <span class="label" style="color: var(--current-text-secondary);">Malicious Clients:</span>
                                    <span class="value danger" id="malicious-count" style="font-weight: bold; color: #e74c3c;">0</span>
                                </div>
                                <div class="info-item">
                                    <span class="label" style="color: var(--current-text-secondary);">Defense Status:</span>
                                    <span class="value success" id="defense-status" style="font-weight: bold; color: #27ae60;">Active</span>
                                </div>
                                <div class="info-item">
                                    <span class="label" style="color: var(--current-text-secondary);">Detection Accuracy:</span>
                                    <span class="value" id="detection-accuracy" style="font-weight: bold; color: var(--primary-blue);">0.00%</span>
                                </div>
                                <div class="info-item">
                                    <span class="label" style="color: var(--current-text-secondary);">Detection F1:</span>
                                    <span class="value" id="detection-f1" style="font-weight: bold; color: var(--primary-blue);">0.00</span>
                                </div>
                            </div>
                            
                            <!-- Attack Detection Controls -->
                            <div class="detection-controls" style="display: flex; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: var(--current-card-bg); border-radius: 8px; border: 1px solid var(--current-border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label for="malicious-percentage" style="color: var(--current-text-secondary); font-weight: 500;">Malicious %:</label>
                                    <input type="range" id="malicious-percentage" min="0" max="50" value="20" style="width: 100px;">
                                    <span id="malicious-percentage-value" style="color: var(--current-text-primary); font-weight: bold;">20%</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label for="epsilon-value" style="color: var(--current-text-secondary); font-weight: 500;">Privacy (ε):</label>
                                    <input type="range" id="epsilon-value" min="0.1" max="2.0" step="0.1" value="1.0" style="width: 100px;">
                                    <span id="epsilon-value-display" style="color: var(--current-text-primary); font-weight: bold;">1.0</span>
                                </div>
                                <button class="btn secondary" onclick="runDetectionWithParams()" style="padding: 8px 16px;">
                                    <i class="fas fa-play"></i> Run Detection
                                </button>
                            </div>
                            
                            <div class="client-table-container" style="overflow-x: auto;">
                                <table class="client-table" id="demo-clients-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--current-card-bg); border-bottom: 2px solid var(--current-border);">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Client ID</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Accuracy</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Loss</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Labels Flipped</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="demo-clients-tbody">
                                        <!-- Client rows will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attack Detection Results -->
                    <div class="chart-card" style="margin-top: 2rem;">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-shield-alt"></i> Attack Detection Results
                            </h3>
                            <div class="chart-controls">
                                <span class="status-indicator">
                                    <span class="status-text" id="detection-status">Ready</span>
                                </span>
                            </div>
                        </div>
                        <div style="padding: 1rem;">
                            <div class="detection-results" id="detection-results" style="display: none;">
                                <div class="results-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                    <div class="result-card" style="padding: 1rem; background: var(--current-card-bg); border-radius: 8px; border: 1px solid var(--current-border-color);">
                                        <div class="result-label" style="color: var(--current-text-secondary); font-size: 0.9em; margin-bottom: 0.5rem;">True Malicious</div>
                                        <div class="result-value" id="true-malicious-count" style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">0</div>
                                    </div>
                                    <div class="result-card" style="padding: 1rem; background: var(--current-card-bg); border-radius: 8px; border: 1px solid var(--current-border-color);">
                                        <div class="result-label" style="color: var(--current-text-secondary); font-size: 0.9em; margin-bottom: 0.5rem;">Detected Malicious</div>
                                        <div class="result-value" id="detected-malicious-count" style="font-size: 1.5em; font-weight: bold; color: #f39c12;">0</div>
                                    </div>
                                    <div class="result-card" style="padding: 1rem; background: var(--current-card-bg); border-radius: 8px; border: 1px solid var(--current-border-color);">
                                        <div class="result-label" style="color: var(--current-text-secondary); font-size: 0.9em; margin-bottom: 0.5rem;">Detection Accuracy</div>
                                        <div class="result-value" id="result-accuracy" style="font-size: 1.5em; font-weight: bold; color: #27ae60;">0.00%</div>
                                    </div>
                                    <div class="result-card" style="padding: 1rem; background: var(--current-card-bg); border-radius: 8px; border: 1px solid var(--current-border-color);">
                                        <div class="result-label" style="color: var(--current-text-secondary); font-size: 0.9em; margin-bottom: 0.5rem;">F1 Score</div>
                                        <div class="result-value" id="result-f1" style="font-size: 1.5em; font-weight: bold; color: #3498db;">0.00</div>
                                    </div>
                                </div>
                                
                                <div class="detection-chart" style="margin-bottom: 2rem;">
                                    <canvas id="detectionChart" width="400" height="200"></canvas>
                                </div>
                                
                                <div class="detection-details" id="detection-details" style="display: none;">
                                    <h4 style="color: var(--current-text-primary); margin-bottom: 1rem;">Detection Details</h4>
                                    <div id="detection-details-content" style="background: var(--current-card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--current-border-color);">
                                        <!-- Details will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="no-results" id="no-detection-results" style="text-align: center; padding: 2rem; color: var(--current-text-secondary);">
                                <i class="fas fa-shield-alt" style="font-size: 3em; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No detection results yet. Click "Run Detection" to start.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <div class="footer-left">
                    <p>&copy; 2025 FL Enterprise Dashboard. All rights reserved.</p>
                </div>
                <div class="footer-right">
                    <a href="#" class="footer-link">Documentation</a>
                    <a href="#" class="footer-link">Support</a>
                    <a href="#" class="footer-link">Privacy Policy</a>
                    <a href="#" class="footer-link">Terms of Service</a>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        const socket = io();
        let systemStatus = 'stopped';
        
        // Theme management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }
            
            // Resize charts after theme change
            setTimeout(resizeAllCharts, 100);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.setAttribute('data-theme', savedTheme);
            themeIcon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            setupEventListeners();
            setupTabs();
            setupResizeHandler();
            
            // Delay initialization to ensure containers are ready
            setTimeout(() => {
                initializeDashboard();
                startMetricsPolling();
            }, 500);
        });

        // Also initialize when window is fully loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!trainingChart) {
                    initializeTrainingChartWithRetry();
                }
                resizeAllCharts();
            }, 500);
        });

        function initializeDashboard() {
            updateSystemStatus('running');
            loadInitialData();
        }

        function setupEventListeners() {
            setupTabs();
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        function setupResizeHandler() {
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    resizeAllCharts();
                }, 100);
            });
        }

        function resizeAllCharts() {
            if (trainingChart) {
                trainingChart.resize();
            }
            
            if (performanceChart) {
                performanceChart.resize();
            }
            
            Object.values(clientCharts).forEach(chart => {
                if (chart) {
                    chart.resize();
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Resize charts after tab switch
            setTimeout(resizeAllCharts, 100);
        }

        function updateSystemStatus(status) {
            systemStatus = status;
            const statusDot = document.getElementById('systemStatusDot');
            const statusText = document.getElementById('systemStatusText');
            const systemStatusElement = document.getElementById('systemStatus');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = status === 'running' ? 'Online' : status.charAt(0).toUpperCase() + status.slice(1);
            if (systemStatusElement) {
                systemStatusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        function loadInitialData() {
            console.log('Loading initial dashboard data...');
            
            // Initialize charts with retry mechanism
            initializeTrainingChartWithRetry();
            initializePerformanceChart();
            
            // Use relative URLs
            const baseUrl = window.location.origin;
            
            // Fetch system status
            fetch(`${baseUrl}/api/system/status`)
                .then(response => response.json())
                .then(data => {
                    console.log('System status:', data);
                    updateSystemStatus(data.status);
                    updateClientCount(data.active_clients, data.clients_count);
                    updateCAStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                });
            
            // Fetch system metrics
            fetch(`${baseUrl}/api/metrics/system`)
                .then(response => response.json())
                .then(data => {
                    console.log('System metrics:', data);
                    updateMetrics({ system: data });
                })
                .catch(error => {
                    console.error('Error fetching system metrics:', error);
                });
            
            // Fetch client metrics
            fetch(`${baseUrl}/api/metrics/clients`)
                .then(response => response.json())
                .then(data => {
                    console.log('Client metrics:', data);
                    updateClientMetrics(data);
                })
                .catch(error => {
                    console.error('Error fetching client metrics:', error);
                });
            
            // Fetch initial training data
            fetch(`${baseUrl}/api/metrics/training`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Training metrics received:', data);
                    updateTrainingChart(data);
                    updateClientCharts(data);
                })
                .catch(error => {
                    console.error('Error fetching training metrics:', error);
                    // Try to show sample data if real data fails
                    console.log('Loading sample data instead...');
                    const sampleData = generateSampleData();
                    updateTrainingChart(sampleData);
                    updateClientCharts(sampleData);
                });
        }
        
        function generateSampleData() {
            // Generate sample data for demonstration
            const sampleData = [];
            for (let round = 1; round <= 5; round++) {
                const clientMetrics = {};
                const accuracies = [];
                
                for (let clientId = 1; clientId <= 10; clientId++) {
                    const accuracy = 0.6 + (round - 1) * 0.08 + Math.random() * 0.1 - 0.05;
                    const loss = 0.8 - (round - 1) * 0.12 + Math.random() * 0.2 - 0.1;
                    
                    clientMetrics[clientId.toString()] = {
                        accuracy: Math.max(0.5, Math.min(0.95, accuracy)),
                        precision: Math.max(0.5, Math.min(0.95, accuracy + Math.random() * 0.1 - 0.05)),
                        recall: Math.max(0.5, Math.min(0.95, accuracy + Math.random() * 0.1 - 0.05)),
                        f1_score: Math.max(0.5, Math.min(0.95, accuracy + Math.random() * 0.1 - 0.05)),
                        loss: Math.max(0.1, Math.min(1.0, loss)),
                        num_examples: Math.floor(Math.random() * 5000) + 20000
                    };
                    accuracies.push(clientMetrics[clientId.toString()].accuracy);
                }
                
                sampleData.push({
                    round: round,
                    avg_accuracy: accuracies.reduce((a, b) => a + b, 0) / accuracies.length,
                    client_metrics: clientMetrics
                });
            }
            return sampleData;
        }

        function updateClientCount(activeClients, totalClients) {
            const activeClientsElement = document.getElementById('activeClients');
            const totalClientsElement = document.getElementById('totalClients');
            const activeTrainingElement = document.getElementById('activeTraining');
            
            if (activeClientsElement) {
                activeClientsElement.textContent = activeClients || 0;
            }
            if (totalClientsElement) {
                totalClientsElement.textContent = totalClients || 0;
            }
            if (activeTrainingElement) {
                activeTrainingElement.textContent = activeClients || 0;
            }
        }

        function updateMetrics(metrics) {
            if (metrics.system) {
                // Update main dashboard metrics
                document.getElementById('cpuUsage').textContent = `${metrics.system.cpu_percent || 0}%`;
                document.getElementById('cpuProgress').style.width = `${metrics.system.cpu_percent || 0}%`;
                
                document.getElementById('memoryUsage').textContent = `${metrics.system.memory_percent || 0}%`;
                document.getElementById('memoryProgress').style.width = `${metrics.system.memory_percent || 0}%`;
                
                // Update containers count
                const dockerContainers = document.getElementById('dockerContainers');
                if (dockerContainers) {
                    let containerCount = 0;
                    if (metrics.system.containers) {
                        containerCount = Object.keys(metrics.system.containers).length;
                    }
                    dockerContainers.textContent = containerCount;
                }

                // Update sidebar quick stats
                const quickCpu = document.getElementById('quickCpu');
                const quickMemory = document.getElementById('quickMemory');
                if (quickCpu) quickCpu.textContent = `${metrics.system.cpu_percent || 0}%`;
                if (quickMemory) quickMemory.textContent = `${metrics.system.memory_percent || 0}%`;

                // Update network traffic (mock data)
                const networkTraffic = document.getElementById('networkTraffic');
                if (networkTraffic) {
                    const traffic = Math.random() * 50; // Mock network traffic
                    networkTraffic.textContent = `${traffic.toFixed(1)} MB/s`;
                }
            }
        }

        function updateCAStatus(systemData) {
            const caStatus = document.getElementById('caStatus');
            const caCertificates = document.getElementById('caCertificates');
            
            if (systemData.ca_status === 'running') {
                if (caStatus) caStatus.textContent = 'Active';
                let certCount = 0;
                if (systemData.containers) {
                    Object.values(systemData.containers).forEach(container => {
                        if (container.type === 'ca') {
                            certCount = container.active_certificates || 0;
                        }
                    });
                }
                if (caCertificates) caCertificates.textContent = certCount;
            } else {
                if (caStatus) caStatus.textContent = 'Inactive';
                if (caCertificates) caCertificates.textContent = '0';
            }
        }

        function updateClientMetrics(clientData) {
            const activeClients = document.getElementById('activeClients');
            if (activeClients) {
                const runningClients = Object.values(clientData).filter(client => client.status === 'running').length;
                activeClients.textContent = runningClients;
            }
        }

        // Chart variables
        let clientCharts = {};
        let trainingChart = null;
        let performanceChart = null;

        function initializePerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            try {
                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'CPU Usage',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: false,
                            tension: 0.1
                        }, {
                            label: 'Memory Usage',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing performance chart:', error);
            }
        }

        function initializeTrainingChartWithRetry(retries = 10) {
            const ctx = document.getElementById('trainingChart');
            if (!ctx) {
                if (retries > 0) {
                    setTimeout(() => initializeTrainingChartWithRetry(retries - 1), 300);
                }
                return;
            }
            
            if (typeof Chart === 'undefined') {
                if (retries > 0) {
                    setTimeout(() => initializeTrainingChartWithRetry(retries - 1), 300);
                }
                return;
            }

            const container = ctx.parentElement;
            if (!container) {
                if (retries > 0) {
                    setTimeout(() => initializeTrainingChartWithRetry(retries - 1), 300);
                }
                return;
            }
            
            const rect = container.getBoundingClientRect();
            
            if (rect.width === 0 || rect.height === 0) {
                if (retries > 0) {
                    setTimeout(() => initializeTrainingChartWithRetry(retries - 1), 300);
                }
                return;
            }

            try {
                initializeTrainingChart();
                console.log('Training chart initialized successfully');
            } catch (error) {
                console.error('Error initializing training chart:', error);
                if (retries > 0) {
                    setTimeout(() => initializeTrainingChartWithRetry(retries - 1), 300);
                }
            }
        }

        function initializeTrainingChart() {
            const ctx = document.getElementById('trainingChart');
            if (!ctx) {
                console.error('Training chart canvas not found');
                return;
            }

            try {
                // Destroy existing chart if it exists
                if (trainingChart) {
                    trainingChart.destroy();
                }

                trainingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Average Accuracy',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 0
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        return (value * 100).toFixed(1) + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 10
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'var(--current-text-primary)'
                                }
                            }
                        }
                    }
                });
                console.log('Training chart created successfully');
            } catch (error) {
                console.error('Error initializing training chart:', error);
            }
        }

        function updateTrainingChart(trainingData) {
            if (!trainingChart) {
                console.log('Training chart not initialized, skipping update');
                return;
            }
            
            if (!trainingData || trainingData.length === 0) {
                console.log('No training data available');
                return;
            }

            console.log('Updating training chart with data:', trainingData);

            const rounds = trainingData.map(d => d.round || d.round_num || 'Round ' + (trainingData.indexOf(d) + 1));
            const accuracies = trainingData.map(d => {
                const acc = d.avg_accuracy || d.accuracy || 0;
                return typeof acc === 'number' ? acc : parseFloat(acc) || 0;
            });

            trainingChart.data.labels = rounds;
            trainingChart.data.datasets[0].data = accuracies;
            trainingChart.update('none'); // Update without animation
            
            // Update model accuracy stat
            const modelAccuracy = document.getElementById('modelAccuracy');
            if (modelAccuracy && accuracies.length > 0) {
                const latestAccuracy = accuracies[accuracies.length - 1];
                modelAccuracy.textContent = `${(latestAccuracy * 100).toFixed(1)}%`;
            }

            // Update completed rounds
            const completedRounds = document.getElementById('completedRounds');
            if (completedRounds) {
                completedRounds.textContent = rounds.length;
            }

            // Update training rounds in sidebar
            const trainingRounds = document.getElementById('trainingRounds');
            if (trainingRounds) {
                trainingRounds.textContent = rounds.length;
            }
            
            console.log('Training chart updated successfully');
        }

        function createClientChart(clientId, container) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            
            const ctx = document.createElement('canvas');
            ctx.id = `clientChart_${clientId}`;
            chartContainer.appendChild(ctx);
            container.appendChild(chartContainer);

            try {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Accuracy',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }, {
                            label: 'Loss',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.1,
                            yAxisID: 'y1',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 0
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        return (value * 100).toFixed(1) + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 8
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'var(--current-text-primary)'
                                }
                            }
                        }
                    }
                });
                console.log(`Client chart created for client ${clientId}`);
                return chart;
            } catch (error) {
                console.error(`Error creating chart for client ${clientId}:`, error);
                return null;
            }
        }

        function updateClientCharts(trainingData) {
            if (!trainingData || trainingData.length === 0) {
                console.log('No training data for client charts');
                return;
            }

            const container = document.getElementById('clientChartsGrid');
            if (!container) {
                console.error('Client charts container not found');
                return;
            }

            console.log('Updating client charts with data:', trainingData);

            // Clear existing charts
            container.innerHTML = '';
            clientCharts = {};

            // Get all unique client IDs from training data
            const clientIds = new Set();
            trainingData.forEach(round => {
                if (round.client_metrics) {
                    Object.keys(round.client_metrics).forEach(clientId => {
                        clientIds.add(clientId);
                    });
                }
            });

            console.log('Found client IDs:', Array.from(clientIds));

            // Create charts for each client
            clientIds.forEach(clientId => {
                const chartItem = document.createElement('div');
                chartItem.className = 'client-chart-item';
                
                const title = document.createElement('h4');
                title.textContent = `Client ${clientId}`;
                chartItem.appendChild(title);

                const chart = createClientChart(clientId, chartItem);
                if (chart) {
                    clientCharts[clientId] = chart;

                    // Update chart with data
                    const rounds = [];
                    const accuracies = [];
                    const losses = [];

                    trainingData.forEach(round => {
                        if (round.client_metrics && round.client_metrics[clientId]) {
                            const roundNum = round.round || round.round_num || 'Round ' + (trainingData.indexOf(round) + 1);
                            const accuracy = round.client_metrics[clientId].accuracy || 0;
                            const loss = round.client_metrics[clientId].loss || 0;
                            
                            rounds.push(roundNum);
                            accuracies.push(typeof accuracy === 'number' ? accuracy : parseFloat(accuracy) || 0);
                            losses.push(typeof loss === 'number' ? loss : parseFloat(loss) || 0);
                        }
                    });

                    chart.data.labels = rounds;
                    chart.data.datasets[0].data = accuracies;
                    chart.data.datasets[1].data = losses;
                    chart.update('none');

                    container.appendChild(chartItem);
                    console.log(`Client ${clientId} chart updated with ${rounds.length} data points`);
                }
            });
            
            console.log(`Created ${Object.keys(clientCharts).length} client charts`);
        }

        function startMetricsPolling() {
            const baseUrl = window.location.origin;
            
            setInterval(() => {
                // Fetch system status for real-time updates
                fetch(`${baseUrl}/api/system/status`)
                    .then(response => response.json())
                    .then(data => {
                        updateSystemStatus(data.status);
                        updateClientCount(data.active_clients, data.clients_count);
                        updateCAStatus(data);
                    })
                    .catch(error => console.error('Error fetching system status:', error));
                
                // Fetch system metrics
                fetch(`${baseUrl}/api/metrics/system`)
                    .then(response => response.json())
                    .then(data => {
                        updateMetrics({ system: data });
                        updatePerformanceChart(data);
                    })
                    .catch(error => console.error('Error fetching system metrics:', error));
                
                // Fetch client metrics
                fetch(`${baseUrl}/api/metrics/clients`)
                    .then(response => response.json())
                    .then(data => {
                        updateClientMetrics(data);
                    })
                    .catch(error => console.error('Error fetching client metrics:', error));
                
                // Fetch training metrics
                fetch(`${baseUrl}/api/metrics/training`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateTrainingChart(data);
                        updateClientCharts(data);
                    })
                    .catch(error => console.error('Error fetching training metrics:', error));
            }, 5000);
        }

        function updatePerformanceChart(systemData) {
            if (!performanceChart || !systemData) return;

            const now = new Date().toLocaleTimeString();
            const cpuUsage = systemData.cpu_percent || 0;
            const memoryUsage = systemData.memory_percent || 0;

            // Keep only last 20 data points
            if (performanceChart.data.labels.length >= 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }

            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(cpuUsage);
            performanceChart.data.datasets[1].data.push(memoryUsage);
            performanceChart.update();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Socket.io event handlers
        socket.on('connect', function() {
            showNotification('Connected to dashboard', 'success');
        });

        socket.on('disconnect', function() {
            showNotification('Connection lost', 'warning');
        });

        socket.on('metrics_update', function(data) {
            updateMetrics(data);
        });

        socket.on('training_update', function(data) {
            updateTrainingChart(data);
            updateClientCharts(data);
        });

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase();
                    // Implement search logic here
                });
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K for search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            // Ctrl/Cmd + Shift + D for dark mode toggle
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleTheme();
            }
        });

        // Auto-refresh functionality
        let autoRefreshInterval;
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showNotification('Auto-refresh disabled', 'info');
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadInitialData();
                }, 30000); // Refresh every 30 seconds
                showNotification('Auto-refresh enabled', 'success');
            }
        }

        // Export functionality
        function exportData(type) {
            const data = {
                timestamp: new Date().toISOString(),
                systemStatus: systemStatus,
                metrics: {
                    cpu: document.getElementById('cpuUsage')?.textContent,
                    memory: document.getElementById('memoryUsage')?.textContent,
                    containers: document.getElementById('dockerContainers')?.textContent
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fl-dashboard-${type}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`${type} data exported successfully`, 'success');
        }

        // Add event listeners for action buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers for buttons (these would connect to actual functionality)
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.onclick && !btn.classList.contains('btn-logout')) {
                    btn.addEventListener('click', function() {
                        const text = this.textContent.trim();
                        if (!text.includes('Reset All') && !text.includes('Refresh') && !text.includes('Simulate')) {
                            showNotification(`${text} clicked - functionality would be implemented here`, 'info');
                        }
                    });
                }
            });
        });

        // Demo Tab Functions
        let demoData = [];
        let demoUpdateInterval;

        function refreshDemoData() {
            fetch('/api/demo/clients')
                .then(response => response.json())
                .then(data => {
                    if (data.clients) {
                        demoData = data.clients;
                        updateDemoTable();
                        updateDemoSummary();
                        showNotification('Demo data refreshed successfully', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing demo data:', error);
                    showNotification('Failed to refresh demo data', 'error');
                });
        }

        function updateDemoTable() {
            const tbody = document.getElementById('demo-clients-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            demoData.forEach(client => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--current-border)';
                
                const statusBadge = client.is_malicious 
                    ? '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> Malicious</span>'
                    : '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;"><i class="fas fa-check"></i> Normal</span>';
                
                const toggleButtonClass = client.is_malicious ? 'btn danger' : 'btn secondary';
                const toggleButtonText = client.is_malicious ? 'Set Normal' : 'Set Malicious';
                const toggleButtonIcon = client.is_malicious ? 'fas fa-shield' : 'fas fa-bug';
                
                row.innerHTML = `
                    <td style="padding: 12px; font-weight: bold; color: var(--primary-blue);">Client ${client.client_id}</td>
                    <td style="padding: 12px;">${statusBadge}</td>
                    <td style="padding: 12px;">${(client.accuracy * 100).toFixed(2)}%</td>
                    <td style="padding: 12px;">${client.loss.toFixed(4)}</td>
                    <td style="padding: 12px;">${client.is_malicious ? 'All labels' : 'None'}</td>
                    <td style="padding: 12px;">
                        <button class="${toggleButtonClass}" onclick="toggleClientStatus(${client.client_id})" style="padding: 6px 12px; font-size: 0.9em;">
                            <i class="${toggleButtonIcon}"></i> ${toggleButtonText}
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateDemoSummary() {
            const maliciousCount = demoData.filter(client => client.is_malicious).length;
            document.getElementById('malicious-count').textContent = maliciousCount;
            document.getElementById('total-clients').textContent = demoData.length;
            
            // Update defense status based on malicious client count
            const defenseStatus = document.getElementById('defense-status');
            if (maliciousCount === 0) {
                defenseStatus.textContent = 'Active';
                defenseStatus.style.color = '#27ae60';
            } else if (maliciousCount <= 3) {
                defenseStatus.textContent = 'Monitoring';
                defenseStatus.style.color = '#f39c12';
            } else {
                defenseStatus.textContent = 'Alert';
                defenseStatus.style.color = '#e74c3c';
            }
        }

        function toggleClientStatus(clientId) {
            document.getElementById('demo-status').textContent = 'Updating...';
            
            fetch(`/api/demo/toggle/${clientId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusText = data.is_malicious ? 'malicious' : 'normal';
                    showNotification(`Client ${clientId} set to ${statusText}`, 'success');
                    refreshDemoData();
                } else {
                    showNotification(`Failed to toggle client ${clientId}: ${data.error}`, 'error');
                }
                document.getElementById('demo-status').textContent = 'Ready';
            })
            .catch(error => {
                console.error('Error toggling client:', error);
                showNotification(`Error toggling client ${clientId}`, 'error');
                document.getElementById('demo-status').textContent = 'Ready';
            });
        }

        function resetAllClients() {
            if (!confirm('Are you sure you want to reset all clients to normal status?')) {
                return;
            }
            
            document.getElementById('demo-status').textContent = 'Resetting...';
            
            fetch('/api/demo/reset_all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    refreshDemoData();
                } else {
                    showNotification(`Failed to reset clients: ${data.error}`, 'error');
                }
                document.getElementById('demo-status').textContent = 'Ready';
            })
            .catch(error => {
                console.error('Error resetting clients:', error);
                showNotification('Error resetting clients', 'error');
                document.getElementById('demo-status').textContent = 'Ready';
            });
        }

        function simulateAttack() {
            // Simulate a Byzantine attack by making 30% of clients malicious
            const clientCount = demoData.length;
            const attackCount = Math.ceil(clientCount * 0.3);
            const normalClients = demoData.filter(client => !client.is_malicious);
            
            if (normalClients.length === 0) {
                showNotification('All clients are already malicious', 'info');
                return;
            }
            
            if (!confirm(`This will make ${Math.min(attackCount, normalClients.length)} clients malicious. Continue?`)) {
                return;
            }
            
            document.getElementById('demo-status').textContent = 'Simulating Attack...';
            
            // Randomly select clients to make malicious
            const clientsToAttack = normalClients
                .sort(() => Math.random() - 0.5)
                .slice(0, Math.min(attackCount, normalClients.length));
            
            let completed = 0;
            clientsToAttack.forEach(client => {
                setTimeout(() => {
                    toggleClientStatus(client.client_id);
                    completed++;
                    if (completed === clientsToAttack.length) {
                        setTimeout(() => {
                            document.getElementById('demo-status').textContent = 'Ready';
                            showNotification(`Attack simulation complete - ${clientsToAttack.length} clients compromised`, 'warning');
                        }, 1000);
                    }
                }, Math.random() * 2000); // Stagger the attacks
            });
        }

        // Attack Detection Functions
        let detectionChart = null;
        let detectionResults = null;

        function runEnhancedDetection() {
            document.getElementById('detection-status').textContent = 'Running Enhanced Detection...';
            
            fetch('/api/detection/run_enhanced', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    use_cached: false
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    detectionResults = data;
                    displayEnhancedDetectionResults(detectionResults);
                    showNotification('Enhanced detection completed successfully', 'success');
                } else {
                    showNotification('Enhanced detection failed: ' + data.error, 'error');
                }
                document.getElementById('detection-status').textContent = 'Ready';
            })
            .catch(error => {
                console.error('Error running enhanced detection:', error);
                showNotification('Error running enhanced detection', 'error');
                document.getElementById('detection-status').textContent = 'Ready';
            });
        }

        function runAttackDetection() {
            document.getElementById('detection-status').textContent = 'Running Demo Detection...';
            
            fetch('/api/detection/run_demo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    malicious_percentage: 20
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    detectionResults = data.result;
                    displayDetectionResults(detectionResults);
                    showNotification('Demo detection completed successfully', 'success');
                } else {
                    showNotification('Demo detection failed: ' + data.error, 'error');
                }
                document.getElementById('detection-status').textContent = 'Ready';
            })
            .catch(error => {
                console.error('Error running demo detection:', error);
                showNotification('Error running demo detection', 'error');
                document.getElementById('detection-status').textContent = 'Ready';
            });
        }

        function runDetectionWithParams() {
            const maliciousPercentage = document.getElementById('malicious-percentage').value;
            const epsilon = document.getElementById('epsilon-value').value;
            
            document.getElementById('detection-status').textContent = 'Running Detection...';
            
            fetch('/api/detection/run_demo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    malicious_percentage: parseInt(maliciousPercentage),
                    epsilon: parseFloat(epsilon)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    detectionResults = data.result;
                    displayDetectionResults(detectionResults);
                    showNotification(`Attack detection completed with ${maliciousPercentage}% malicious clients`, 'success');
                } else {
                    showNotification('Attack detection failed: ' + data.error, 'error');
                }
                document.getElementById('detection-status').textContent = 'Ready';
            })
            .catch(error => {
                console.error('Error running attack detection:', error);
                showNotification('Error running attack detection', 'error');
                document.getElementById('detection-status').textContent = 'Ready';
            });
        }

        function displayEnhancedDetectionResults(results) {
            // Show results section
            document.getElementById('detection-results').style.display = 'block';
            document.getElementById('no-detection-results').style.display = 'none';
            
            // Update summary cards with enhanced detection data
            const detected_malicious = results.detected_malicious || [];
            const total_clients = results.total_clients || 0;
            
            document.getElementById('true-malicious-count').textContent = 'N/A (Real FL)';
            document.getElementById('detected-malicious-count').textContent = detected_malicious.length;
            
            const metrics = results.detection_metrics || {};
            const accuracy = metrics.accuracy || 0;
            const f1 = metrics.f1_score || 0;
            
            document.getElementById('result-accuracy').textContent = (accuracy * 100).toFixed(2) + '%';
            document.getElementById('result-f1').textContent = f1.toFixed(3);
            
            // Update main dashboard metrics
            document.getElementById('detection-accuracy').textContent = (accuracy * 100).toFixed(2) + '%';
            document.getElementById('detection-f1').textContent = f1.toFixed(3);
            
            // Show detection method and timing
            const method = results.detection_summary?.detection_method || 'unknown';
            const time = results.detection_time || 0;
            console.log(`Enhanced Detection: ${method}, Time: ${time.toFixed(3)}s, Clients: ${total_clients}`);
            
            // Create detection chart
            createDetectionChart(results);
            
            // Show detection details
            showDetectionDetails(results);
        }

        function displayDetectionResults(results) {
            // Show results section
            document.getElementById('detection-results').style.display = 'block';
            document.getElementById('no-detection-results').style.display = 'none';
            
            // Update summary cards
            document.getElementById('true-malicious-count').textContent = results.true_malicious.length;
            document.getElementById('detected-malicious-count').textContent = results.detected_malicious.length;
            
            const accuracy = results.metrics.accuracy || 0;
            const f1 = results.metrics.f1_score || 0;
            
            document.getElementById('result-accuracy').textContent = (accuracy * 100).toFixed(2) + '%';
            document.getElementById('result-f1').textContent = f1.toFixed(3);
            
            // Update main dashboard metrics
            document.getElementById('detection-accuracy').textContent = (accuracy * 100).toFixed(2) + '%';
            document.getElementById('detection-f1').textContent = f1.toFixed(3);
            
            // Create detection chart
            createDetectionChart(results);
            
            // Show detection details
            showDetectionDetails(results);
        }

        function createDetectionChart(results) {
            const ctx = document.getElementById('detectionChart').getContext('2d');
            
            if (detectionChart) {
                detectionChart.destroy();
            }
            
            const clientLosses = results.client_losses;
            const trueMalicious = results.true_malicious;
            const detectedMalicious = results.detected_malicious;
            
            // Prepare data for visualization
            const labels = clientLosses.map((_, index) => `Client ${index + 1}`);
            const lossData = clientLosses.map(loss => loss * 100); // Convert to percentage
            
            // Color coding
            const backgroundColors = clientLosses.map((_, index) => {
                if (trueMalicious.includes(index) && detectedMalicious.includes(index)) {
                    return '#27ae60'; // True positive - green
                } else if (trueMalicious.includes(index) && !detectedMalicious.includes(index)) {
                    return '#e74c3c'; // False negative - red
                } else if (!trueMalicious.includes(index) && detectedMalicious.includes(index)) {
                    return '#f39c12'; // False positive - orange
                } else {
                    return '#3498db'; // True negative - blue
                }
            });
            
            detectionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Client Loss (%)',
                        data: lossData,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Attack Detection Results - Client Losses',
                            color: 'var(--current-text-primary)'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Loss (%)',
                                color: 'var(--current-text-primary)'
                            },
                            ticks: {
                                color: 'var(--current-text-secondary)'
                            },
                            grid: {
                                color: 'var(--current-border-color)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Client ID',
                                color: 'var(--current-text-primary)'
                            },
                            ticks: {
                                color: 'var(--current-text-secondary)'
                            },
                            grid: {
                                color: 'var(--current-border-color)'
                            }
                        }
                    }
                }
            });
        }

        function showDetectionDetails(results) {
            const detailsContent = document.getElementById('detection-details-content');
            const metrics = results.metrics;
            
            let detailsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div>
                        <h5 style="color: var(--current-text-primary); margin-bottom: 0.5rem;">Detection Metrics</h5>
                        <p><strong>Accuracy:</strong> ${(metrics.accuracy * 100).toFixed(2)}%</p>
                        <p><strong>Precision:</strong> ${(metrics.precision * 100).toFixed(2)}%</p>
                        <p><strong>Recall:</strong> ${(metrics.recall * 100).toFixed(2)}%</p>
                        <p><strong>F1 Score:</strong> ${metrics.f1_score.toFixed(3)}</p>
                    </div>
                    <div>
                        <h5 style="color: var(--current-text-primary); margin-bottom: 0.5rem;">Detection Counts</h5>
                        <p><strong>True Positives:</strong> ${metrics.true_positives || 0}</p>
                        <p><strong>False Positives:</strong> ${metrics.false_positives || 0}</p>
                        <p><strong>False Negatives:</strong> ${metrics.false_negatives || 0}</p>
                        <p><strong>Total Detected:</strong> ${results.detected_malicious.length}</p>
                    </div>
                    <div>
                        <h5 style="color: var(--current-text-primary); margin-bottom: 0.5rem;">Client Details</h5>
                        <p><strong>True Malicious:</strong> [${results.true_malicious.map(i => i + 1).join(', ')}]</p>
                        <p><strong>Detected Malicious:</strong> [${results.detected_malicious.map(i => i + 1).join(', ')}]</p>
                        <p><strong>Detection Rate:</strong> ${((results.detected_malicious.length / results.true_malicious.length) * 100).toFixed(1)}%</p>
                    </div>
                </div>
            `;
            
            detailsContent.innerHTML = detailsHtml;
            document.getElementById('detection-details').style.display = 'block';
        }

        function toggleDetection() {
            fetch('/api/detection/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.enabled ? 'Enabled' : 'Disabled';
                    showNotification(`Attack detection ${status}`, 'success');
                    updateDetectionStatus();
                } else {
                    showNotification('Failed to toggle detection', 'error');
                }
            })
            .catch(error => {
                console.error('Error toggling detection:', error);
                showNotification('Error toggling detection', 'error');
            });
        }

        function updateDetectionStatus() {
            fetch('/api/detection/status')
                .then(response => response.json())
                .then(data => {
                    if (data.enabled) {
                        document.querySelector('button[onclick="toggleDetection()"]').innerHTML = '<i class="fas fa-toggle-on"></i> Disable Detection';
                    } else {
                        document.querySelector('button[onclick="toggleDetection()"]').innerHTML = '<i class="fas fa-toggle-off"></i> Enable Detection';
                    }
                })
                .catch(error => {
                    console.error('Error updating detection status:', error);
                });
        }

        // Update slider values
        document.getElementById('malicious-percentage').addEventListener('input', function() {
            document.getElementById('malicious-percentage-value').textContent = this.value + '%';
        });

        document.getElementById('epsilon-value').addEventListener('input', function() {
            document.getElementById('epsilon-value-display').textContent = this.value;
        });

        // Auto-refresh demo data when demo tab is active
        function startDemoAutoRefresh() {
            if (demoUpdateInterval) {
                clearInterval(demoUpdateInterval);
            }
            demoUpdateInterval = setInterval(() => {
                const demoTab = document.getElementById('demo');
                if (demoTab && demoTab.classList.contains('active')) {
                    refreshDemoData();
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Override switchTab to handle demo tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'demo') {
                refreshDemoData();
                startDemoAutoRefresh();
            }
        };

    </script>
</body>
</html>